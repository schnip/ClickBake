window.SU||(window.SU={}),"undefined"!=typeof SNI_COMMUNITY_SOCIAL_UPLOAD&&SNI_COMMUNITY_SOCIAL_UPLOAD||(SNI_COMMUNITY_SOCIAL_UPLOAD={}),"undefined"!=typeof SNI_COMMUNITY_SERVICES&&SNI_COMMUNITY_SERVICES||(SNI_COMMUNITY_SERVICES={}),SNI_COMMUNITY_SOCIAL_UPLOAD.APP_KEY=FD.Config.SocialUploader.apiKey,$.extend(!0,SU,{config:{imageDomain:FD.Config.SocialUploader.cloudinaryImgBasePath,imageService:"cloudinary"}}),$.extend(!0,FD.Config.SocialUploader,{cloudinaryPath:function(url){var defaults={staticPath:"http://"+FD.Config.SocialUploader.cloudinaryImgBasePath+"/image/upload/v1",env:""},split=url.split(defaults.staticPath);return defaults.staticPath+FD.Config.SocialUploader.cloudinaryPathPrefix+split[1]}}),$.extend(!0,FD.Config.SocialUploader,{cloudinaryAvatarPath:function(url){var defaults={staticPath:"http://"+FD.Config.SocialUploader.cloudinaryImgBasePath+"/image/upload/v1/img/avatar",env:""},split=url.split(defaults.staticPath);return defaults.staticPath.replace("/img/avatar","")+FD.Config.SocialUploader.cloudinaryAvatarPathPrefix+split[1]}}),$.extend(!0,FD.Config.SocialUploader,{socialUploadS3FilePath:function(typeWithPrefix,assetId){var socialupload={s3:{bucketName:"",imagePath:""},typeWithPrefix:"",splitConfig:{},splitRegex:/(.{2})|(.)$/g,splitReplace:"/$1$2"};socialupload.splitConfig.recipe={doSplit:!0,bucketAssetName:"recipes"},socialupload.splitConfig["cookbook-cover"]={doSplit:!0,bucketAssetName:"cookbook-cover"},socialupload.splitConfig["menu-item"]={doSplit:!1,bucketAssetName:"menu-item"},socialupload.splitConfig["menu-cover"]={doSplit:!1,bucketAssetName:"menu-cover"},socialupload.splitConfig["recipe-submission"]={doSplit:!1,bucketAssetName:"submissions/recipe"},socialupload.splitConfig.seasonal={doSplit:!1,bucketAssetName:"seasonal-header"},socialupload.splitConfig.slideshow={doSplit:!1,bucketAssetName:"slideshow-item"},socialupload.splitConfig["member-avatar"]={doSplit:!1,bucketAssetName:"avatar"};var requestedDomain=document.domain;if(requestedDomain.contains(".food.com"))socialupload.s3.bucketName="/img";else if(requestedDomain.contains(".dev1-food.com"))socialupload.s3.bucketName="/img";else{if(!requestedDomain.contains(".qa1-food.com"))return void 0;socialupload.s3.bucketName="/img"}var processedId=assetId;return processedId=socialupload.splitConfig[typeWithPrefix].doSplit?processedId.replace(socialupload.splitRegex,socialupload.splitReplace):"/"+processedId,socialupload.s3.imagePath=socialupload.s3.bucketName+"/"+socialupload.splitConfig[typeWithPrefix].bucketAssetName+processedId+"/",socialupload.s3.imagePath}}),function(){$.fn.dialog||($.fn.dialog=function(){});var DEBUG=function(){if("undefined"!=typeof log)log(arguments);else if("undefined"!=typeof console)try{log.apply(null,arguments)}catch(e){log(arguments)}},domainPattern=/^((?:(https?):)?(?:\/\/)?([^\/]+))/,getUrlPrefix=function(url){var result=domainPattern.exec(url);return null===result?null:result[1]},parseRestResponseToHash=function(data){if("undefined"==typeof data)throw new Error("response data was undefined!");if("undefined"==typeof data.responseData)throw new Error("response.responseData was undefined!");if("object"!=typeof data.responseData.nameValuePair||data.responseData.nameValuePair instanceof Array==!1)throw new Error("unknown data format in resopnse.responseData!");var i,result={};for(i=0;i<data.responseData.nameValuePair.length;i+=1)result[data.responseData.nameValuePair[i].name]=data.responseData.nameValuePair[i].value;return result},preTriggerArgs=null;$.extend(!0,window.FD,{uploader:function(el){preTriggerArgs=arguments}});var waitForModuleTrack=function(obj,ModuleName,LinkTitle,LinkPosition,LocUrl,TargetURL,EventType){if("undefined"==typeof moduleTrack)var intervalCount=0,detectModuleTrack=setInterval(function(){intervalCount+=1,log("waiting for moduleTrack method","interval: "+intervalCount),(moduleTrack||intervalCount>12)&&(moduleTrack(obj,ModuleName,LinkTitle,LinkPosition,LocUrl,TargetURL,EventType),clearInterval(detectModuleTrack))},250);else moduleTrack(obj,ModuleName,LinkTitle,LinkPosition,LocUrl,TargetURL,EventType)};log("-------------"),log("About to do socialUploaderContextLoaded..."),log("-------------"),window.socialUploaderContextLoaded(function(jQuery){var $=jQuery;$.extend(!0,window.FD,{uploader:function(el,suPickOptions,suStoreOptions,suAssetMetaData){var $el=$(el),pickOptions=FD.Config.SocialUploader.pickOptions||{},storeOptions=FD.Config.SocialUploader.storeOptions||{},assetMetaData={};successHandler=successMethodDefault,$el.size()>0&&("undefined"!=typeof $el.data("suPickOptions")&&$.extend(!0,pickOptions,$el.data("suPickOptions")),"undefined"!=typeof $el.data("suStoreOptions")&&$.extend(!0,storeOptions,$el.data("suStoreOptions")),"undefined"!=typeof $el.data("suAssetMetaData")&&$.extend(!0,assetMetaData,$el.data("suAssetMetaData"))),"object"==typeof suPickOptions&&$.extend(!0,pickOptions,suPickOptions),"object"==typeof suStoreOptions&&$.extend(!0,storeOptions,suStoreOptions),"object"==typeof suAssetMetaData&&$.extend(!0,assetMetaData,suAssetMetaData),"recipe-submission"===assetMetaData.asset_type&&(successHandler=successMethodRecipeSubmission),"member-avatar"===assetMetaData.asset_type&&(successHandler=successMethodAvatarSubmission);var typeWithPrefix=assetMetaData.file_type?assetMetaData.asset_type+"-"+assetMetaData.file_type:assetMetaData.asset_type;$.extend(!0,FD.Config.SocialUploader,{socialUploadFileTypeWithPrefix:typeWithPrefix}),$.extend(!0,FD.Config.SocialUploader,{socialUploadAssetMetaData:assetMetaData});var filePrefix="";"slideshow-item"===typeWithPrefix||"seasonal-header"===typeWithPrefix?$.ajax({url:FD.Config.SocialUploader.preSubmitUrl.replace("{assetType}",typeWithPrefix),cache:!1,data:{assetid:assetMetaData.asset_id},async:!1}).done(function(data,status,request){responseObj=parseRestResponseToHash(data),filePrefix=responseObj.fdcNamePrefix}):filePrefix=FD.Config.SocialUploader.socialUploadS3FilePath(typeWithPrefix,assetMetaData.asset_id),"undefined"!=typeof filePrefix&&(storeOptions.path=filePrefix,waitForModuleTrack(this,"Community Image Upload","NA","NA",location.href,"on_page_interaction","upload_attempt"),CP_SERVICE_FILE_UPLOAD.uploadFile(successHandler,errorMethod,assetMetaData,pickOptions,storeOptions))}}),null!==preTriggerArgs&&FD.uploader.apply(null,preTriggerArgs);var errorMethod=function(){alert("Error occured while uploading file "+error)},successMethodDefault=function(data){typeWithPrefix=FD.Config.SocialUploader.socialUploadFileTypeWithPrefix,assetMetaData=FD.Config.SocialUploader.socialUploadAssetMetaData,log("FilepickerData Return: "+JSON.stringify(data));var i,paths=[];for(i=0;i<data.length;i+=1){var url=data[i].url;paths.push(url)}FD.publish("fd.photo-upload.saving",[assetMetaData.asset_id]),$.ajax({url:FD.Config.SocialUploader.preSubmitUrl.replace("{assetType}",typeWithPrefix),cache:!1,data:{assetid:assetMetaData.asset_id}}).then(function(data,status,request){responseObj=parseRestResponseToHash(data),$.ajax({url:FD.Config.SocialUploader.submitUrl.replace("{assetType}",typeWithPrefix),data:{tid:responseObj.transId,fname:paths.join("|"),assetid:assetMetaData.asset_id,type:assetMetaData.asset_type},success:function(jsonData){DEBUG("My last success---"+JSON.stringify(jsonData));var autoApproveFlag=void 0!=assetMetaData.file_type&&"item"!=assetMetaData.file_type||"true"==jsonData.responseData.nameValuePair[1].value;autoApproveFlag?FD.publish("fd.photo-upload.complete.autoapprove",[assetMetaData.asset_id]):"item"==assetMetaData.file_type?FD.publish("fd.photo-upload.complete",[assetMetaData.asset_id]):FD.publish("fd.photo-upload.complete",[assetMetaData.asset_id]),waitForModuleTrack(this,"Community Image Upload","NA","NA",location.href,"on_page_interaction","upload_success"),waitForModuleTrack(this,"Community Image Upload","NA",paths.length,location.href,"on_page_interaction","image_total")},error:function(xhr,ajaxOptions,thrownError){},timeout:18e4})})},successMethodRecipeSubmission=function(data){filePickerData=data,typeWithPrefix=FD.Config.SocialUploader.socialUploadFileTypeWithPrefix,assetMetaData=FD.Config.SocialUploader.socialUploadAssetMetaData,log("In recipe submission success..."+typeWithPrefix+" ---"+JSON.stringify(data));var i,paths=[];for(i=0;i<data.length;i+=1){var url=data[i].url,prefix=getUrlPrefix(url);null!==prefix&&(url=url.substring(prefix.length+9),"/"!=url.charAt(0)&&(url="/"+url)),paths.push(url)}$.ajax({url:FD.Config.SocialUploader.preSubmitUrl.replace("{assetType}",typeWithPrefix),cache:!1,data:{assetid:assetMetaData.asset_id}}).then(function(data,status,request){responseObj=parseRestResponseToHash(data),$.ajax({url:FD.Config.SocialUploader.submitUrl.replace("{assetType}",typeWithPrefix),data:{tid:responseObj.transId,fname:paths.join("|"),assetid:assetMetaData.asset_id,type:assetMetaData.asset_type},success:function(jsonData){DEBUG("My last success---"+JSON.stringify(jsonData));var newFName=jsonData.responseData.nameValuePair[0].value;FD.publish("social-upload-photo-added",[SU.util.resizeCloudinaryImage(FD.Config.SocialUploader.cloudinaryPath(filePickerData[0].url),"w_262,q_92"),responseObj.transId,newFName]),waitForModuleTrack(this,"Community Image Upload","NA","NA",location.href,"on_page_interaction","upload_success"),waitForModuleTrack(this,"Community Image Upload","NA",paths.length,location.href,"on_page_interaction","image_total")},error:function(xhr,ajaxOptions,thrownError){alert("Error processing photo")},timeout:18e4})})},successMethodAvatarSubmission=function(data){filePickerData=data,typeWithPrefix=FD.Config.SocialUploader.socialUploadFileTypeWithPrefix,assetMetaData=FD.Config.SocialUploader.socialUploadAssetMetaData,log("In recipe submission success..."+typeWithPrefix+" ---"+JSON.stringify(data));var i,paths=[];for(i=0;i<data.length;i+=1){var url=data[i].url,prefix=getUrlPrefix(url);null!==prefix&&(url=url.substring(prefix.length+9),"/"!=url.charAt(0)&&(url="/"+url)),paths.push(url)}FD.publish("fd.photo-upload.saving",["success-"]),$.ajax({url:FD.Config.SocialUploader.preSubmitUrl.replace("{assetType}",typeWithPrefix),cache:!1,data:{assetid:assetMetaData.asset_id}}).then(function(data,status,request){responseObj=parseRestResponseToHash(data),$.ajax({url:FD.Config.SocialUploader.submitUrl.replace("{assetType}",typeWithPrefix),data:{tid:responseObj.transId,fname:paths.join("|"),assetid:assetMetaData.asset_id,type:assetMetaData.asset_type},success:function(jsonData){DEBUG("My last success---"+JSON.stringify(jsonData));jsonData.responseData.nameValuePair[0].value;FD.publish("social-upload-photo-added",[SU.util.resizeCloudinaryImage(FD.Config.SocialUploader.cloudinaryAvatarPath(filePickerData[0].url),"q_92"),SU.util.resizeCloudinaryImage(FD.Config.SocialUploader.cloudinaryAvatarPath(filePickerData[0].url),"w_45,h_45,q_92,c_thumb")]),waitForModuleTrack(this,"Community Image Upload","NA","NA",location.href,"on_page_interaction","upload_success"),waitForModuleTrack(this,"Community Image Upload","NA",paths.length,location.href,"on_page_interaction","image_total")},error:function(xhr,ajaxOptions,thrownError){alert("Error processing photo")},timeout:18e4})})}}),log("Setting up Click track on Photo Upload"),FD.subscribe("fd.photo-upload.open",function(args){return FD.Session.isSignedIn()?void FD.uploader($(args[0])):(FD.Util.isGigyaEnabled()?FD.Session.register():AIMHook("register"),!1)}),FD.subscribe("fd.photo-upload.saving",function(args){$("#"+args.replace(".","-")+"_socialupload").modal("show")}),FD.subscribe("fd.photo-upload.complete",function(args){$("#"+args.replace(".","-")+"_socialupload").find(".modal-body").html('<b>Success! Thanks for uploading.</b><br>We will notify you when your photo has been approved and published.<br>This usually takes a day or so.<br><br><button data-dismiss="modal">Done</button>')}),FD.subscribe("fd.photo-upload.complete.autoapprove",function(args){$("#"+args.replace(".","-")+"_socialupload").find(".modal-body").html("<b>Success! Thanks for uploading.</b>"),setTimeout(function(){$("#"+args+"_socialupload").modal("hide"),location.reload()},5e3)})}();