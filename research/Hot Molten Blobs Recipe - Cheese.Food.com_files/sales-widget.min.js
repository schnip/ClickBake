!function($){function Template(html,tokenBorders){this.tokenBorders=tokenBorders||["\\{\\{","\\}\\}"],this.html=html}function SalesWidget(options){var self=this;self.settings=$.extend(!0,{},defaults,options||{}),self.templates={container:'<div class="sales-widget"></div>',anonymous:'<header><h4>On Sale Near You</h4><a class="no-geo-close" href="#"><i class="'+self.settings.selectors.iconClose.replace(".","")+'"></i></a></header><p>See what\'s on sale in recipes and in your Grocery List.</p><p><a href="'+self.settings.services.stores+"?url="+encodeURIComponent(window.location.href)+'">Find stores</a></p>',header:'<header><h4><span class="sales-count"></span>&nbsp;<span class="sales-text"></span></h4><div class="header-action-link"><span class="zip-code"><i class="icon-fdc-map-pin"></i>&nbsp;</span>&nbsp;|&nbsp;<span class="edit-location"><a href="'+self.settings.services.stores+"?url="+encodeURIComponent(window.location.href)+'">Edit</a></span></div></header>',saleItemContainer:'<div class="sale-item-container"></div>',saleItem:'<div class="sale-item-section"><h4 class="sale-item">{{sale-item}}</h4><h5 class="sale-location-price">'+self.settings.html.saleTag+'<span class="sale-location">{{sale-location}}</span>&nbsp;|&nbsp;<span class="sale-price">{{sale-price}}</span></h5><h5 class="sale-description">{{sale-description}}</h5><h5 class="sale-expiration">Expires <span class="sale-expiration-date">{{sale-expiration-date}}</span></h5></div>',footer:'<footer class="clearfix"><span class="sales-widget-feedback"><a href="'+self.settings.services.feedback+'">Feedback?</a></span></footer>',showMoreSales:'<span class="more-sales"><a href="#">Show more sales <i class="icon-fdc-navigate-down"></i></a></span>'},$(self.settings.selectors.target).removeClass("hidden"),window.location.pathname.contains("/recipe/best-banana-bread-2886")||window.location.pathname.contains("/recipe/moist-and-delicious-banana-bread-252449")||window.location.pathname.contains("/recipe/moist-and-delicious-banana-bread-412782")||window.location.pathname.contains("/recipe/sour-cream-banana-bread-9351")||window.location.pathname.contains("/recipe/banana-bread-muffins-486453")||window.location.pathname.contains("/recipe/banana-bread-brownies-507176")||window.location.pathname.contains("/recipe/best-banana-bread-2886")||window.location.pathname.contains("/recipe/weight-watcher-1-point-banana-bread-flex-points-154636")||window.location.pathname.contains("/recipe/quick-and-easy-eggless-banana-bread-447487")||window.location.pathname.contains("/recipe/lorilous-quick-n-easy-banana-bread-477133")||window.location.pathname.contains("/recipe/banana-banana-bread-25885")||window.location.pathname.contains("/recipe/applesauce-banana-bread-151301")||window.location.pathname.contains("/recipe/simple-vegan-banana-bread-368209")||window.location.pathname.contains("/recipe/sugar-free-banana-bread-192871")||window.location.pathname.contains("/recipe/buttermilk-banana-bread-121840")||window.location.pathname.contains("/recipe/low-calorie-banana-bread-389441")||window.location.pathname.contains("/recipe/southern-livings-cream-cheese-banana-bread-364985")||window.location.pathname.contains("/recipe/paula-deen-banana-bread-244423")||window.location.pathname.contains("/recipe/moist-chocolate-chip-banana-bread-157942")||window.location.pathname.contains("/recipe/bobs-red-mill-easy-gluten-free-banana-bread-168634")||window.location.pathname.contains("/recipe/yes-virginia-there-is-a-great-meatloaf-54257")||window.location.pathname.contains("/recipe/turkey-meatloaf-54752")||window.location.pathname.contains("/recipe/really-great-meatloaf-146768")||window.location.pathname.contains("/recipe/cracker-barrel-meatloaf-351062")||window.location.pathname.contains("/recipe/crock-pot-meatloaf-184426")||window.location.pathname.contains("/recipe/meatloaf-41755")||window.location.pathname.contains("/recipe/really-good-vegetarian-meatloaf-really-33921")||window.location.pathname.contains("/recipe/easy-stove-top-stuffing-meatloaf-399162")||window.location.pathname.contains("/recipe/unbelievable-chicken-meatloaf-88410")||window.location.pathname.contains("/recipe/quaker-oats-meatloaf-48663")||window.location.pathname.contains("/recipe/pizza-meatloaf-cups-320658")||window.location.pathname.contains("/recipe/quick-easy-bbq-meatloaf-5-ingredients-351755")||window.location.pathname.contains("/recipe/souperior-meatloaf-101454")||window.location.pathname.contains("/recipe/boston-market-meatloaf-by-todd-wilbur-28927")||window.location.pathname.contains("/recipe/turkey-meatloaf-104321")||window.location.pathname.contains("/recipe/turkey-meatloaf-104321")||window.location.pathname.contains("/recipe/meatloaf-muffins-with-stove-top-stuffing-195530")||window.location.pathname.contains("/recipe/easy-old-fashioned-meatloaf-106650")||window.location.pathname.contains("/recipe/darrells-crock-pot-meatloaf-117641")||window.location.pathname.contains("/recipe/easy-1lb-meatloaf-316609")||self.init()}Template.prototype.encodeRegExChar=function(c){var schars={"\\":"&#92;","^":"&#94;",$:"&#36;",".":"&#46;","|":"&#124;","?":"&#63;","*":"&#42;","+":"&#43;","(":"&#40;",")":"&#41;","[":"&#91;","{":"&#123;"};return schars[c]?schars[c]:c},Template.prototype.render=function(data){var field,val,token,re,chars,self=this,markup=self.html;if(markup.length)for(field in data)val=data[field]||"","null"==val&&(val=null),val&&"string"==typeof val&&(chars=$.map(val.split(""),function(c){return self.encodeRegExChar(c)}),val=chars.join("")),token=self.tokenBorders[0]+field+self.tokenBorders[1],re=new RegExp(token,"gi"),markup=markup.replace(re,val);return markup};var defaults={selectors:{iconClose:".icon-fdc-close",ingredientItem:"[data-ingredient]",target:".ingredients"},services:{feedback:"/submitfeedback.do",stores:"/user/stores"},requestUrl:{origin:window.location.origin,path:"/services/mobile/deals/sales?site=fdc",requestParams:{latLong:""}},html:{saleTag:'<i class="icon-fdc-sale-tag" title="On sale nearby!"></i>'},user:{isSignedIn:!1}};SalesWidget.prototype.init=function(){var self=this;self.getUserLocation(),self.setEventHandlers()},SalesWidget.prototype.getUserLocation=function(){var self=this,successCallback=self.setLatLong.bind(self),errorCallback=self.geoError.bind(self);"undefined"==typeof sessionStorage.latLongQuery?navigator.geolocation.getCurrentPosition(successCallback,errorCallback):(self.settings.requestUrl.requestParams.latLong=sessionStorage.latLongQuery,self.buildRequestURL())},SalesWidget.prototype.setLatLong=function(position){var self=this,latLongQuery="&lat="+position.coords.latitude+"&lng="+position.coords.longitude;self.settings.requestUrl.requestParams.latLong=latLongQuery,sessionStorage.setItem("latLongQuery",latLongQuery),self.buildRequestURL()},SalesWidget.prototype.geoError=function(err){var self=this;switch(err.code){case 1:console.info(err.message);break;case 2:console.error(err.message);break;case 3:console.warn(err.message);break;default:console.error(err.message)}self.settings.user.isSignedIn?self.buildRequestURL():self.displayDefaultWidget()},SalesWidget.prototype.buildRequestURL=function(){var self=this,requestUrl=self.settings.requestUrl,url=requestUrl.origin+requestUrl.path+requestUrl.requestParams.latLong+self.getIngredients();self.getSalesData(url)},SalesWidget.prototype.getSalesData=function(url){var self=this;$.ajax({url:url,type:"GET",dataType:"json",success:function(json){"undefined"!=typeof json.ingredients&&(json.ingredients.length>0?self.displaySalesWidget(json):self.noSales(json))},error:function(xhr,status,errorThrown){console.error("Error loading sales data!"),console.log("Error: "+errorThrown),console.log("Status: "+status),console.dir(xhr)},complete:function(xhr,status){console.log("Sales data request complete.")}})},SalesWidget.prototype.displaySalesWidget=function(json){var saleItemTemplate,templateData,self=this,templates=self.templates,$SalesWidget=$(templates.container),$header=$(templates.header),headerSalesCount=0,headerSalesText=1===json.ingredients.length&&1===json.ingredients[0].sales.length?"Sale":"Sales",$saleItemContainer=$(templates.saleItemContainer),$footer=$(templates.footer),requestNameArray=[],salesArray=[];$header.find(".zip-code").append(json.requestParams.zip_code),$header.find(".sales-text").text(headerSalesText),$SalesWidget.append($header),$SalesWidget.append($saleItemContainer),$SalesWidget.append($footer),$.each(json.ingredients,function(i,ingredient){$.each(ingredient.sales,function(j,sale){sale.requestName=ingredient.name})}),$.each(json.ingredients,function(index,item){salesArray=salesArray.concat(item.sales)}),salesArray.length>2&&$SalesWidget.find("footer").prepend(templates.showMoreSales),$.each(salesArray,function(index,item){return-1===requestNameArray.indexOf(item.requestName)&&requestNameArray.push(item.requestName),saleItemTemplate=new Template(templates.saleItem),templateData={"sale-item":item.name,"sale-location":item.store.name,"sale-price":item.price,"sale-description":item.description,"sale-expiration-date":self.getFormattedDate(item.ends)},saleItemTemplate=$(saleItemTemplate.render(templateData)),headerSalesCount>=2&&saleItemTemplate.addClass("hide-me"),$SalesWidget.find(".sale-item-container").append(saleItemTemplate),headerSalesCount++,$SalesWidget.find(".sales-count").text(headerSalesCount),7===headerSalesCount?!1:void 0}),$(self.settings.selectors.target).append($SalesWidget),$(document).trigger("saleswidget",{state:"sales"}),self.displaySalesTags(requestNameArray)},SalesWidget.prototype.noSales=function(json){$(document).trigger("saleswidget",{state:"none"})},SalesWidget.prototype.getFormattedDate=function(isoDate){var dateObject=new Date(isoDate),formattedDate=dateObject.getMonth()+1+"/"+dateObject.getDate()+"/"+dateObject.getFullYear();return formattedDate},SalesWidget.prototype.getIngredients=function(){var self=this,ingredientParam="&ingred[]=",ingredients=$(self.settings.selectors.ingredientItem),ingredientsQuery="";return $.each(ingredients,function(index,item){ingredientsQuery+=ingredientParam+$(item).data("ingredient")}),ingredientsQuery},SalesWidget.prototype.displaySalesTags=function(ingredientsArray){var encodedItem,self=this,ingredients=$(self.settings.selectors.ingredientItem),encodedIngredients=[];encodedIngredients=ingredientsArray.map(function(item){return encodedItem=encodeURIComponent(item),encodedItem.replace(/%20/g,"+")}),$.each(ingredients,function(index,item){-1!==encodedIngredients.indexOf($(item).data("ingredient"))&&$(item).append(self.settings.html.saleTag)})},SalesWidget.prototype.displayDefaultWidget=function(){var self=this,settings=self.settings,$noGeoWidget=$(self.templates.container);$noGeoWidget.append(self.templates.anonymous),$(settings.selectors.target).append($noGeoWidget),$(document).trigger("saleswidget",{state:"default"})},SalesWidget.prototype.setEventHandlers=function(){$(document).on("click",".sales-widget .no-geo-close",function(event){event.preventDefault(),$(".sales-widget").slideUp("slow")}),$(document).on("click",".more-sales",function(event){event.preventDefault(),$(this).closest(".sales-widget").find(".hide-me").slideDown("slow"),$(this).remove(),$(document).trigger("saleswidget",{state:"sales:ShowMoreSales"})})},window.SalesWidget=SalesWidget}(jQuery);