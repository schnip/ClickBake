log("FD.contentrotator"),function($,rz){function majorVersion(v){return v.split(".").slice(0,1).join(".")}$.lazyLoadImage=function(img,onload,onerror){if(img&&img.length&&!img.attr("src")){onload&&img.on("load",onload),onerror&&img.on("error",onerror),img.hide();var i=new Image;i.src=img.attr("data-src"),img.attr("src",img.attr("data-src")),img.fadeIn("fast")}},$.widget("fd.contentrotater",{options:{autostart:!1,isCircular:!0,pushHistory:!1,showCaption:!1,showNavigation:!0,showPagination:!0,startIndex:0,transitionType:"slide",navigation:{container:"slideshow-nav",back:"back",next:"next"},pagination:{container:"pagination",position:"slideshow-page",separator:" of ",total:"slideshow-total"},slides:{container:"slides",current:"curr",description:"slide-description",next:"next",photo:"slide-photo",previous:"prev",slide:"slide",idAttribute:"data-slide-position"},events:{dataLoaded:"slideshow-dataloaded",viewSlide:"slideshow-viewslide"},methods:{init:function(instance){log("CRinit")},showContainer:function(container){return container.show()},hideContainer:function(container){return container.hide()}}},_create:function(){var pagPosition,pagTotal,prop,ev,self=$.extend(!0,this,this.options.methods),settings=self.options,circular=settings.isCircular,container=self.element,slides=settings.slides,navigation=(settings.cssclass,settings.content,settings.navigation),navContainer=$("."+navigation.container,container),pagination=settings.pagination,pagContainer=settings.pagination&&settings.showPagination?$("."+pagination.container,container):null,div="<div></div>",button='<a class="button"></a>',span="<span></span>",clickEvent=function(instance,event){return function(e){e.preventDefault(),self.addClickCount(),e.target.className.contains("disabled")||instance[event].call(this,e)}};self.__id="SS_"+FD.Page.getUniqueId(),self.total=settings.slideCount||0,self.clickCount=0,self.addClickCount=function(){self.clickCount++},self.toggleNavButtons=function(position){!circular&&position&&(position==self.total?(self.navNext.addClass("disabled"),self.navBack.removeClass("disabled")):1==position?(self.navNext.removeClass("disabled"),self.navBack.addClass("disabled")):(self.navNext.removeClass("disabled"),self.navBack.removeClass("disabled")))},self.events=$.extend({},settings.events);for(prop in self.events)ev=self.events[prop],self.events[prop]=ev+"."+self.__id;self.viewport=$('[class$="'+slides.container+'"]',container),self.items=$("."+slides.slide,self.viewport),self.template=self.viewport.clone(),self.viewport.css("min-height",self.viewport.height()+"px"),self.init&&"function"==typeof self.init&&self.init.call(self),self.getCurrentPosition=function(){log("::getCurrentPosition::");var slide=container.find("."+slides.current),position=parseInt(slide.attr("data-slide-position"),10);return isNaN(position)?1:position},settings.showNavigation?(0===navContainer.length?(log("NAVIGATION DNE"),navContainer=$(div).addClass(navigation.container).hide().prependTo(container),self.navBack=$(button).addClass(navigation.back).appendTo(navContainer).text("Back"),self.navNext=$(button).addClass(navigation.next).appendTo(navContainer).text("Next")):(log("NAVIGATION EXISTS"),self.navBack=$("."+navigation.back,navContainer),self.navNext=$("."+navigation.next,navContainer)),settings.showPagination?(0===pagContainer.length?(pagTotal=$(span).addClass(pagination.total).text(0).insertAfter(self.navBack),$(span).insertAfter(self.navBack).text(pagination.separator),pagPosition=$(span).addClass(pagination.position).insertAfter(self.navBack).text(settings.startIndex+1)):(pagPosition=$("."+pagination.container+" ."+pagination.position).text(settings.startIndex+1),pagTotal=$("."+pagination.total)),rz.subscribe(self.events.dataLoaded,function(ssInstance){log("events.dataloaded");var $ss=ssInstance.element;$ss.data.recipeId==self.element.data.recipeId&&(currentSlide=container.find("."+slides.container+" ."+slides.current),pagPosition.text(currentSlide.attr(slides.idAttribute)),pagTotal.text(ssInstance.total))}),rz.subscribe(self.events.viewSlide,function(slide){log("events.viewSlide"),pagPosition.text(slide.position)})):pagContainer&&pagContainer.hide(),rz.subscribe(self.events.viewSlide,function(slide){log("events.viewSlide"),self.toggleNavButtons(slide.position)}),self.element.on("touchstart click",".slideshow-nav .back",clickEvent(self,"back")).on("touchstart click",".slideshow-nav .next",clickEvent(self,"next")),self.toggleNavButtons(settings.startIndex+1),self.showContainer(navContainer)):navContainer.hide()},destroy:function(){this.options.destroy&&"function"==typeof this.options.destroy&&this.options.destroy.call(this),$.Widget.prototype.destroy.call(this)},_setOption:function(key,value){"1.9"===majorVersion($.ui.version)?this._super("_setOption",key,value):$.Widget.prototype._setOption.apply(this,arguments)}})}(jQuery,FD),function($){$(function(){var options={pushHistory:!0,isCircular:!0,showPagination:!1,numSlidesOnScreen:5,centerSlideIndex:2,navigation:{container:"slideshow-nav",back:"back",next:"next",reverse:"reverse"},pagination:{container:"pagination",position:"slideshow-page",separator:"slash",total:"slideshow-total"},slides:{container:"slides",current:"current",description:"slide-description",next:"next",photo:"slide-photo",previous:"prev",slide:"slide",idAttribute:"data-slide-position"},events:{dataLoaded:"slideshow-dataloaded",viewSlide:"slideshow-viewslide"},url:{pageViewCandidate:FD.Config.apiServerURL+"/services/mobile/comscore/pageViewCandidate"},methods:{loadSlide:function(li,index){var instance=this,settings=instance.options,slide=instance.slides[instance.checkIndex(index)],position="string"==typeof slide.position?parseInt(slide.position,10):slide.position,template=instance.template;li.data("slide",slide).attr(settings.slides.idAttribute,position),template&&("undefined"==typeof slide.html&&(li.attr(settings.slides.idAttribute,position).addClass("slide"),slide.html=template.render(slide)),li.html(slide.html),$.lazyLoadImage(li.find("img.slide-photo")))},checkIndex:function(index){var instance=this;return index>instance.slides.length-1?index-instance.slides.length:0>index?instance.slides.length+index:index},moveSlide:function(e,dir){if("undefined"===e)return 0;var instance=this,settings=instance.options,centerSlideIndex=settings.centerSlideIndex,ul=$(e.target).closest(".slideshow_content").find("ul"),slides=$("li",ul),currentSlide=slides.eq(centerSlideIndex),nextSlide=slides.eq(centerSlideIndex+dir),queuedSlide=dir>0?slides.first():slides.last(),nextIndex=nextSlide.data("slide").position-1;e.stopImmediatePropagation(),dir>0?queuedSlide.appendTo(ul):queuedSlide.prependTo(ul),currentSlide.removeClass(instance.options.slides.current),nextSlide.addClass(instance.options.slides.current),instance.currentIndex=nextIndex,instance.loadSlide(queuedSlide,nextIndex+dir*centerSlideIndex),FD.publish(instance.events.viewSlide,[nextSlide.data("slide")])},getSlideData:function(){return{slides:FD.Page.Recipe.recipes[FD.Page.Recipe.current.id].picList.slides}},setUpSlides:function(list,activePosition){var instance=this,data=instance.getSlideData();centerSlideIndex=instance.options.centerSlideIndex,slideIndexOffset=activePosition-1-centerSlideIndex,activeSlide=list.find("li").eq(centerSlideIndex),instance.template=instance.getTemplate(),instance.slides=data.slides,list.find("li").each(function(i){var index=slideIndexOffset+i,li=$(this);i===centerSlideIndex&&li.addClass(instance.options.slides.current),instance.loadSlide(li,index)}),FD.publish(instance.events.dataLoaded,[instance]),instance.slidesInitialized=!0},setUpEvents:function(){var instance=this,pageContainer=(instance.options,instance.element);instance.next=function(e){log("NEXT"),SniAds.Gallery.next(),instance.moveSlide(e,1)},instance.back=function(e){log("PREV"),SniAds.Gallery.previous(),instance.moveSlide(e,-1)},pageContainer.on("touchstart MSPointerDown pointerdown",".slideshow_content",function(e){var eTouch=e&&e.originalEvent&&e.originalEvent.changedTouches[0]||{},startX=eTouch.pageX||0,startY=eTouch.pageY||0;instance.swipeX=startX,instance.swipeY=startY,log("start: "+startX+" , "+startY)}).on("touchmove",".slideshow_content",function(e){var eTouch=e&&e.originalEvent&&e.originalEvent.changedTouches[0]||{},moveX=eTouch.pageX||0,moveY=eTouch.pageY||0,buffer=2,horizontalSwipe=Math.abs(moveX-instance.swipeX)*buffer>Math.abs(moveY-instance.swipeY);horizontalSwipe&&e.preventDefault()}).on("swipeLeft",".slideshow_content",function(e){instance.next(e)}).on("swipeRight",".slideshow_content",function(e){instance.back(e)}),FD.subscribe("History.statechange",function(state){var photoPosition=state.data.position;photoPosition&&(log("photoPosition= "+photoPosition),instance.setUpSlides(instance.list,photoPosition))}),FD.subscribe(instance.events.viewSlide,function(slide){var url=new FD.Url;url.querystring.val("photo",slide.photoId),FD.History.push(slide,instance.title+": Food.com",url.toString()),$("meta[property=og\\:image]").attr("content",slide.url),$("meta[property=og\\:url]").attr("content",url.toString());var currentMdManagerPageType=mdManager.getParameter("TYPE");mdManager.setParameter("TYPE","RECIPE_PHOTO"),FD.publish("fd.omniture.pageview.fire",[]),$.ajax({url:options.url.pageViewCandidate,type:"GET",dataType:"json",cache:!1,xhrFields:{withCredentials:!0},complete:function(request){mdManager.setParameter("TYPE",currentMdManagerPageType)}})}),FD.subscribe(instance.events.viewSlide,function(slide){$.each($("input[name='photo']"),function(key,elem){$(elem).val(slide.photoId)})}),FD.subscribe("fd.lazyload.image",function(img){img&&!img.jquery&&(img=$(img));var w=img.width();img.siblings(".img-overlay").width(w)})},getTemplate:function(){var byline,instance=this,settings=(instance.element,instance.options),centerSlideIndex=settings.centerSlideIndex,list=instance.element.find("."+settings.slides.container),activeSlide=list.find("li").eq(centerSlideIndex),template=activeSlide.clone(),pho=template.find("img."+settings.slides.photo).attr("src","").attr("data-src","{{url}}").attr(instance.options.slides.idAttribute,"{{position}}").end().find(".photographer");return pho.length&&(byline=pho.find("a"),0==byline.length&&(pho.append('<a href=""></a>'),byline=pho.find("a")),byline.text("{{by}}").attr("href","{{profileUrl}}")),template.html().trim()},init:function(){var instance=this,settings=(instance.element,instance.options),centerSlideIndex=settings.centerSlideIndex,list=instance.element.find("."+settings.slides.container),activeSlide=list.find("li").eq(centerSlideIndex),activePosition=parseInt(activeSlide.attr(instance.options.slides.idAttribute),10);instance.title=document.title,instance.list=list,instance.template=instance.getTemplate(),instance.setUpSlides(list,activePosition),instance.setUpEvents(list,activePosition)}}};$(function(){FD.Page.Slideshow={},FD.Page.Slideshow.options=options,FD.Page.Slideshow.init=function(){this.setUpEvents(),this.setUpSlideshow(FD.Page.Recipe.current.id)},FD.Page.Slideshow.setUpEvents=function(){$(document).on("click",".current .add-pictures",function(e){FD.publish("fd.photo-upload.open",$(e.target))})},FD.Page.Slideshow.setUpSlideshow=function(id){var $slideshow,slides=FD.Page.Recipe.recipes[id].picList.slides||[],currentSlideshow='[data-recipe-id="'+id+'"] .slideshow',ssMarkupExists=$(currentSlideshow).length>0,dataForSlideshow=slides.length>1,instance=FD.Page.Recipe.recipes[id].slideshow;!instance&&ssMarkupExists&&dataForSlideshow?(instance=FD.Page.Recipe.recipes[id].slideshow=$(currentSlideshow).contentrotater(options),$slideshow=instance.element,SniAds.Gallery.init({galleryCfg:{container:currentSlideshow,dismiss_elts:"dismissEl",disable_elts:"disableEl",dismiss_elts:".pg-next, .pg-previous",disable_elts:".dismiss1, .dismiss2"}}),SniAds.Event.subscribe("interstitialStart",function(){$(".slideshow-interstitial").css("zIndex",9999)})):(log("No slideshow"),$('article[data-recipe-id="'+id+'"]').find(".slideshow .onephoto img").each(function(){var img=$(this),src=img.attr("src"),i=$("<img/>");i.on("error",function(){img.parents(".jumbotron").addClass("nophoto")}).attr("src",src)}))},FD.Page.Slideshow.init(),FD.subscribe("fd.feed.page.changed",function(){FD.Page.Slideshow&&FD.Page.Slideshow.setUpSlideshow&&FD.Page.Slideshow.setUpSlideshow(FD.Page.Recipe.current.id)})})})}(jQuery);